<!DOCTYPE html>
<html lang="en">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <title>GridWorks Dashboard</title>

    <style>
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
        }

        table {
            width: 100%;
            max-width: 700px; 
            min-width: 300px; 
            margin-top: 20px;
            border-collapse: collapse;
            text-align: left;
        }

        th {
            background-color: #e0e0e0;
            font-weight: bold;
            padding: 10px;
        }

        td {
            padding: 10px;
        }

        pre {
            background-color: #f4f4f4;
            padding: 10px;
            border: 1px solid #ccc;
            margin-top: 20px;
            white-space: pre-wrap;
        }

        #Plots img {
            display: block;
            max-width: 100%;
            height: auto;
            margin: 10px 0;
        }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <script>
        let house_alias, password; // global equivalent

        async function fetchTemperatureData(house_alias, password) {
            try {
                const response = await fetch(`https://4fa2-34-205-125-68.ngrok-free.app/${house_alias}/thermostats`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ password: password })
                });
                
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const temperatureData = await response.json();
                populateTable(temperatureData, house_alias);
            } catch (error) {
                console.error('Error fetching temperature data:', error);
                alert(`Error fetching temperature data for house '${house_alias}'.`);
            }
        }

        function populateTable(data, house_alias) {
            const tbody = document.getElementById("temperature-data");
            tbody.innerHTML = "";
            const zones = {};
            let time_of_reading = '';

            data.forEach(item => {
                const parts = item.zone.split('-');
                const zoneBase = parts.slice(0, parts.length-1).join('-');
                
                if (!time_of_reading) {
                    time_of_reading = item.time;
                }
                if (item.zone.includes('set')) {
                    zones[zoneBase] = zones[zoneBase] || {};
                    zones[zoneBase].setpoint = item.temperature;
                } else if (item.zone.includes('temp')) {
                    zones[zoneBase] = zones[zoneBase] || {};
                    zones[zoneBase].temperature = item.temperature;
                }
            });

            const date = new Date(time_of_reading);
            const formattedTime = date.toLocaleString();
            document.getElementById("houseAliasHeader").textContent = `Thermostats at ${house_alias} on ${formattedTime}`;

            for (const zone in zones) {
                const row = document.createElement("tr");

                const zoneCell = document.createElement("td");
                zoneCell.textContent = zone;
                row.appendChild(zoneCell);

                const setpointCell = document.createElement("td");
                setpointCell.textContent = zones[zone].setpoint !== undefined ? zones[zone].setpoint.toFixed(1) : "N/A";
                row.appendChild(setpointCell);

                const temperatureCell = document.createElement("td");
                temperatureCell.textContent = zones[zone].temperature !== undefined ? zones[zone].temperature.toFixed(1) : "N/A";
                row.appendChild(temperatureCell);

                tbody.appendChild(row);
            }
        }

        async function fetchHpData(house_alias, password, start_ms, end_ms) {
            try {
                const response = await fetch(`https://4fa2-34-205-125-68.ngrok-free.app/${house_alias}?start_ms=${start_ms}&end_ms=${end_ms}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ password: password })
                });
                
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const hpPowerData = await response.json();

                document.getElementById("hpPowerData").innerHTML = '';
                const table = document.createElement("table");
                table.border = "1";
                const headerRow = document.createElement("tr");
                const oduHeader = document.createElement("th");
                oduHeader.textContent = "HP ODU Power";
                headerRow.appendChild(oduHeader);
                const iduHeader = document.createElement("th");
                iduHeader.textContent = "HP IDU Power";
                headerRow.appendChild(iduHeader);
                table.appendChild(headerRow);

                const maxLength = Math.max(hpPowerData.hp_odu_pwr.length, hpPowerData.hp_idu_pwr.length);
                for (let i = 0; i < maxLength; i++) {
                    const row = document.createElement("tr");

                    const oduCell = document.createElement("td");
                    oduCell.textContent = hpPowerData.hp_odu_pwr[i] !== undefined ? hpPowerData.hp_odu_pwr[i] : "N/A";
                    row.appendChild(oduCell);

                    const iduCell = document.createElement("td");
                    iduCell.textContent = hpPowerData.hp_idu_pwr[i] !== undefined ? hpPowerData.hp_idu_pwr[i] : "N/A";
                    row.appendChild(iduCell);

                    table.appendChild(row);
                }
                
                document.getElementById("hpPowerData").appendChild(table);

            } catch (error) {
                console.error('Error fetching HP power data:', error);
                alert(`Error fetching HP power data for house '${house_alias}'.`);
            }
        }

        async function fetchPlots(house_alias, password, start_ms, end_ms) {
            try {
                const response = await fetch(`https://4fa2-34-205-125-68.ngrok-free.app/${house_alias}/plots?start_ms=${start_ms}&end_ms=${end_ms}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ password: password, start_ms: start_ms, end_ms: end_ms })
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const blob = await response.blob();
                const zip = await JSZip.loadAsync(blob);
                const plotsDiv = document.getElementById('Plots');
                plotsDiv.innerHTML = '';

                Object.keys(zip.files).forEach(async (filename) => {
                    const fileData = await zip.files[filename].async('blob');
                    const imgUrl = URL.createObjectURL(fileData);
                    
                    const img = document.createElement('img');
                    img.src = imgUrl;
                    img.alt = 'Plot Image';
                    plotsDiv.appendChild(img);
                });

            } catch (error) {
                console.error('Error fetching plots:', error);
                alert(`Error fetching plots for house '${house_alias}'.`);
            }
        }

        function getDefaultDate() {
            const defaultDate = new Date('2024-10-14T11:00:00');
            return defaultDate.toISOString().split('T')[0];
        }

        function getDefaultTime() {
            const defaultTime = new Date('2024-10-14T11:00:00');
            return defaultTime.toTimeString().split(' ')[0].substring(0, 5);
        }

        function HousePassword() {
            house_alias = prompt("Enter house alias:");
            password = prompt("Enter password:");

            fetchTemperatureData(house_alias, password);
            document.getElementById("houseAliasHeader").textContent = `Loading thermostat data for ${house_alias}...`;
            document.getElementById('datePicker').value = getDefaultDate();
            document.getElementById('timePicker').value = getDefaultTime();
            document.getElementById("content").style.display = "block";
        }

        function getData(event) {
            event.preventDefault();
            const date = document.getElementById('datePicker').value;
            const time = document.getElementById('timePicker').value;
            const dateObject = new Date(`${date}T${time}`);
            const unixMilliseconds = dateObject.getTime();
            const unixMilliseconds_end = unixMilliseconds + 1000 * 60 * 60; // 1 hour later

            fetchPlots(house_alias, password, unixMilliseconds, unixMilliseconds_end)
            // fetchHpData(house_alias, password, unixMilliseconds, unixMilliseconds_end);
        }
    </script>

</head>

<body onload="HousePassword()">
    <div id="content" style="display: none;">
        <h2 id="houseAliasHeader">Thermostat data</h2>
        <table border="1">
            <thead>
                <tr>
                    <th>Zone</th>
                    <th>Setpoint (F)</th>
                    <th>Temperature (F)</th>
                </tr>
            </thead>
            <tbody id="temperature-data">
            </tbody>
        </table>
        <h3>Show HP power for a given hour (New York time)</h3>
        <form onsubmit="getData(event)">
            <label for="datePicker">Choose a date:</label>
            <input type="date" id="datePicker" name="datePicker">
            <br><br>
            <label for="timePicker">Choose a time:</label>
            <input type="time" id="timePicker" name="timePicker">
            <br><br>
            <input type="submit" value="Submit">
        </form>
        <!-- <pre id="hpPowerData"></pre> -->
        <div id="Plots"></div>
    </div>
</body>

</html>
