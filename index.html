<!DOCTYPE html>
<html lang="en">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <title>Thermostats</title>

    <style>
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
        }

        table {
            width: 100%;
            max-width: 700px; 
            min-width: 300px; 
            margin-top: 20px;
            border-collapse: collapse;
            text-align: left;
        }

        th {
            background-color: #e0e0e0;
            font-weight: bold;
            padding: 10px;
        }

        td {
            padding: 10px;
        }

        pre {
            background-color: #f4f4f4;
            padding: 10px;
            border: 1px solid #ccc;
            margin-top: 20px;
            white-space: pre-wrap; /* Preserve whitespace */
        }
    </style>
    
    <script>
        let house_alias, password; // Declare variables for global access

        async function fetchTemperatureData(house_alias, password) {
            try {
                const response = await fetch(`http://localhost:8000/thermostats/${house_alias}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ password: password })
                });
                
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const temperatureData = await response.json();
                populateTable(temperatureData, house_alias);
            } catch (error) {
                console.error('Error fetching temperature data:', error);
                alert(`Error fetching temperature data for house '${house_alias}'.`);
            }
        }

        function populateTable(data, house_alias) {
            const tbody = document.getElementById("temperature-data");
            tbody.innerHTML = "";
            const zones = {};
            let time_of_reading = '';

            data.forEach(item => {
                const parts = item.zone.split('-');
                const zoneBase = parts.slice(0, parts.length-1).join('-');
                
                if (!time_of_reading) {
                    time_of_reading = item.time;
                }
                if (item.zone.includes('set')) {
                    zones[zoneBase] = zones[zoneBase] || {};
                    zones[zoneBase].setpoint = item.temperature;
                } else if (item.zone.includes('temp')) {
                    zones[zoneBase] = zones[zoneBase] || {};
                    zones[zoneBase].temperature = item.temperature;
                }
            });

            const date = new Date(time_of_reading);
            const formattedTime = date.toLocaleString();
            document.getElementById("houseAliasHeader").textContent = `Thermostats at ${house_alias} on ${formattedTime}`;

            for (const zone in zones) {
                const row = document.createElement("tr");

                const zoneCell = document.createElement("td");
                zoneCell.textContent = zone;
                row.appendChild(zoneCell);

                const setpointCell = document.createElement("td");
                setpointCell.textContent = zones[zone].setpoint !== undefined ? zones[zone].setpoint.toFixed(1) : "N/A";
                row.appendChild(setpointCell);

                const temperatureCell = document.createElement("td");
                temperatureCell.textContent = zones[zone].temperature !== undefined ? zones[zone].temperature.toFixed(1) : "N/A";
                row.appendChild(temperatureCell);

                tbody.appendChild(row);
            }
        }

        async function fetchHpData(house_alias, password, start_ms, end_ms) {
            try {
                const response = await fetch(`http://localhost:8000/hp_power/${house_alias}?start_ms=${start_ms}&end_ms=${end_ms}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ password: password })
                });
                
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const hpPowerData = await response.json();
                console.log('HP Power Data:', hpPowerData); // Log the data to check

                // Display the HP power data in JSON format
                document.getElementById("hpPowerData").textContent = JSON.stringify(hpPowerData, null, 2);
            } catch (error) {
                console.error('Error fetching HP power data:', error);
                alert(`Error fetching HP power data for house '${house_alias}'.`);
            }
        }

        function getDefaultDate() {
            // Set the default date to October 14, 2024
            const defaultDate = new Date('2024-10-14T00:00:00'); // New York time (EDT)
            return defaultDate.toISOString().split('T')[0]; // Format: YYYY-MM-DD
        }

        function getDefaultTime() {
            // Set the default time to 12:00 AM
            const defaultTime = new Date('2024-10-14T00:00:00'); // New York time (EDT)
            return defaultTime.toTimeString().split(' ')[0].substring(0, 5); // Format: HH:MM
        }

        function HousePassword() {
            house_alias = prompt("Enter house alias:");
            password = prompt("Enter password:");

            fetchTemperatureData(house_alias, password);
            document.getElementById("houseAliasHeader").textContent = `Loading thermostat data for ${house_alias}...`;
            document.getElementById("content").style.display = "block";

            // Set default values for date and time
            document.getElementById('datePicker').value = getDefaultDate();
            document.getElementById('timePicker').value = getDefaultTime();
        }

        function getData(event) {
            event.preventDefault(); // Prevent form submission
            const date = document.getElementById('datePicker').value;
            const time = document.getElementById('timePicker').value;
            const dateObject = new Date(`${date}T${time}`);
            const unixMilliseconds = dateObject.getTime();
            const unixMilliseconds_end = unixMilliseconds + 1000 * 60 * 60; // 1 hour later

            console.log(`Selected datetime in Unix ms: ${unixMilliseconds}`);
            fetchHpData(house_alias, password, unixMilliseconds, unixMilliseconds_end);
        }
    </script>

</head>

<body onload="HousePassword()">
    <div id="content" style="display: none;">
        <h2 id="houseAliasHeader">Thermostat data</h2>
        <table border="1">
            <thead>
                <tr>
                    <th>Zone</th>
                    <th>Setpoint (F)</th>
                    <th>Temperature (F)</th>
                </tr>
            </thead>
            <tbody id="temperature-data">
            </tbody>
        </table>
        <h3>Show HP power for a given hour (New York time!)</h3>
        <form onsubmit="getData(event)">
            <label for="datePicker">Choose a date:</label>
            <input type="date" id="datePicker" name="datePicker">
            <br><br>
            <label for="timePicker">Choose a time:</label>
            <input type="time" id="timePicker" name="timePicker">
            <br><br>
            <input type="submit" value="Submit">
        </form>

        <!-- Section to display HP power data -->
        <h3>HP Power Data:</h3>
        <pre id="hpPowerData"></pre>
    </div>
</body>

</html>
